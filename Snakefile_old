from shutil import copyfile, move, rmtree, unpack_archive

configfile:	"config/config.yaml"
configfile:	"technology-data/config.yaml"

module technology_data:
    snakefile:  "technology-data/Snakefile"
    config:     config
    prefix:     "technology-data"


target_years = [2028]
climate_years = [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36]

ruleorder: base_model > update_capacities

rule retrieve_all_data:
	input:	
		expand("resources/FBMC/Nordic_{year}.h5", year=[2028, 2030, 2033, 2035]),
		"data/pecd.zip",
		"data/fb_domains.zip",
		"data/pemmdb.zip",
		"data/thermal.zip",
		"resources/res_profile.h5",
		"resources/demand.h5",
		"resources/inflow.h5",	
		"data/ntc.zip",
		"resources/capacity_tables/individual_plants.h5",
		"resources/maintenance_profiles.h5",
		"data/invest_cost.zip",
		#"resources/ntcs.h5",
		#"resources/dispatchable_capacities.h5",
		#"resources/dsr.h5",
		#"resources/all_capacities.h5",
		#"resources/investcap.h5",
		#resources/networks/0/cy1_ty2030.nc",
		expand("results/networks/0/cy{cy}_ty{ty}.nc", cy = climate_years, ty=target_years)


rule retrieve_ntc:
	input:
		storage("https://eepublicdownloads.blob.core.windows.net/public-cdn-container/clean-documents/sdc-documents/ERAA/ERAA_2025/Preliminary_input_data/NTCs.zip"),
	output:
		protected("data/ntc.zip"),
	resources:	
		mem_mb=5000
	retries:
		2
	run:	
		move(input[0], output[0])

rule retrieve_pecd:
	input:
		storage("https://eepublicdownloads.blob.core.windows.net/public-cdn-container/clean-documents/sdc-documents/ERAA/ERAA_2025/Preliminary_input_data/PECD-RES.zip")
	output:	
		protected("data/pecd.zip"),
	resources:	
		mem_mb=5000
	retries:
		2
	run:	
		move(input[0], output[0])

rule retrieve_fb_domains:
	input:	storage("https://eepublicdownloads.blob.core.windows.net/public-cdn-container/clean-documents/sdc-documents/ERAA/ERAA_2025/Preliminary_input_data/FB_domains.zip"),
	output:	protected("data/fb_domains.zip")
	run:	move(input[0], output[0])

rule retrieve_pemmdb:
	input:	storage("https://eepublicdownloads.blob.core.windows.net/public-cdn-container/clean-documents/sdc-documents/ERAA/ERAA_2025/Preliminary_input_data/Dashboard_raw_data.zip"),
	output:	protected("data/pemmdb.zip"),
	resources:
		mem_mb=5000,
	retries:
		2
	run:	
		move(input[0], output[0])

rule retrieve_thermaldata:
	input:
		storage("https://eepublicdownloads.blob.core.windows.net/public-cdn-container/clean-documents/sdc-documents/ERAA/ERAA_2025/Preliminary_input_data/Common_data.zip"),
	output:
		protected("data/thermal.zip"),
	resources:
		mem_mb=5000,
	retries:
		2
	run:
		move(input[0], output[0])

rule retrieve_demand:
	input:
		storage("https://eepublicdownloads.blob.core.windows.net/public-cdn-container/clean-documents/sdc-documents/ERAA/ERAA_2025/Preliminary_input_data/Demand_data.zip")
	output:
		protected("data/demand.zip"),
	resources:
		mem_mb=5000,
	retries:
		2
	log:
		"logs/retrieve_demand.log"
	run:
		move(input[0], output[0])


rule retrieve_nuts24_shapes:
	input:
		storage("https://gisco-services.ec.europa.eu/distribution/v2/nuts/download/ref-nuts-2024-01m.geojson.zip")
	output:
		protected("data/nuts24_regions.zip")
	retries:
		2
	run:
		move(input[0], output[0])
			
rule retrieve_nuts13_shapes:
	input:
		storage("https://gisco-services.ec.europa.eu/distribution/v2/nuts/download/ref-nuts-2013-01m.geojson.zip")
	output:
		protected("data/nuts13_regions.zip")
	retries:
		2
	run:
		move(input[0], output[0])


rule retrieve_moldova_shapes:
	input:
		storage("https://data.humdata.org/dataset/3cd53554-3ad7-4aae-b862-9bbbc6fa3bfc/resource/e93ce536-41e6-41ed-a3b4-71268c1d677e/download/mda_admbnda_unhcr_20220510_shp.zip")
	output:
		protected("data/moldova_regions.zip")
	retries:
		2
	run:
		move(input[0], output[0])


rule retrieve_DSR:
	input:	storage("https://eepublicdownloads.blob.core.windows.net/public-cdn-container/clean-documents/sdc-documents/ERAA/ERAA_2025/Preliminary_input_data/Other_data.zip"),
	output:
		protected("data/dsr.zip"),
	resources:
		mem_mb=5000,
	retries:
		2
	log:
		"logs/retrieve_demand.log"
	run:
		move(input[0], output[0])

rule retrieve_investment_cost:
	input:	storage("https://eepublicdownloads.blob.core.windows.net/public-cdn-container/clean-documents/sdc-documents/ERAA/ERAA_2025/Economic%20and%20technical%20investment%20parameters.zip"),
	output:
		protected("data/invest_cost.zip"),
	resources:
		mem_mb=5000,
	retries:
		2
	log:
		"logs/investment_cost.log"
	run:
		move(input[0], output[0])


rule prepare_common_data:
	input:	invest = "data/invest_cost.zip",
		thermal = "data/thermal.zip"
	params:	data_folder = "data/"
	output:	economic_data = "resources/economic_data.h5",
		technology_parameters = "resources/technology_parameters.h5",
	script:	"scripts/prepare_common_data.py"

rule build_availability_factors:
	input:
		pecd = "data/pecd.zip",
	params:	
		data_folder="data/",
	output:
		res_profile = "resources/res_profile.h5",
	script:
		"scripts/build_availability_factors.py"

rule build_hydro_inflows:
	input:	res_profile = "resources/res_profile.h5", # this is a pseudo input. It serves only for starting the build_hydro_inflows rule once the previous rule has unpacked the PECD data
	params:	
		data_folder = "data/"
	output:
		inflow = "resources/inflow.h5"
	script:
		"scripts/build_hydro_inflows.py"

rule build_ntc:
	input:	ntc="data/ntc.zip",
	params:	folder = "data/"
	output:	save_hdf= "resources/ntcs.h5"
	script:	"scripts/build_ntc.py"

rule build_dispatchable_capacities:
	input:	
		dsr = "data/dsr.zip",
		pemmdb = "data/pemmdb.zip",
		thermal = "data/thermal.zip",
		technology_parameters = "resources/technology_parameters.h5",
	params:	data_folder = "data/"
	output:	dispatchable_capacities = "resources/dispatchable_capacities.h5",
		all_capacities = "resources/all_capacities.h5",
		dsr = "resources/dsr.h5",
		investcap = "resources/investcap.h5",
		commodity_prices = "data/Dashboard_raw_data/Commodity Prices.csv",
		battery = "data/Dashboard_raw_data/Batteries additional information.csv",
		hydrodata = "data/Dashboard_raw_data/Hydro additional information.csv",
		reserve_requirements = "data/Dashboard_raw_data/Reserve requirements.csv",
	script:	"scripts/build_dispatchable_capacities.py"

rule build_demand:
	input:	
		demand_files = "data/demand.zip",
	params:
		demand_folder = "data/demand/",
	output:
		demand = "resources/demand.h5",
	script:	"scripts/build_demand.py"

rule build_bidding_zones:
	input:
		nuts24 = "data/nuts24_regions.zip",
		nuts13 = "data/nuts13_regions.zip",
		moldova = "data/moldova_regions.zip",
	params:
		extract_to = "data/nuts_regions/",
	output:
		bidding_zones = "resources/bidding_zones.geojson"
	script:	"scripts/build_bidding_zones.py"


rule build_individual_power_plants:
	input:	technology_parameters = "resources/technology_parameters.h5",
			bidding_zones = "resources/bidding_zones.geojson",
			dispatchable_capacities = "resources/dispatchable_capacities.h5",
	params:
			typical_size = config["power_plants"]["typical_size"],
			de_minimis = config["power_plants"]["de_minimis"],
	output:	
			individual_power_plants = "resources/capacity_tables/individual_plants.h5",
	script:	"scripts/build_individual_power_plants.py"

rule base_model:
	input:	
		commodity_prices = "data/Dashboard_raw_data/Commodity Prices.csv",
<<<<<<< HEAD
=======
		battery = "data/Dashboard_raw_data/Batteries additional information.csv",
		dsr = "resources/dsr.h5",
		hydrodata = "data/Dashboard_raw_data/Hydro additional information.csv",
>>>>>>> main
		inflow = "resources/inflow.h5",
		#pemmdb = "data/pemmdb.xlsx",
		demand = "resources/demand.h5",
		ntc = "resources/ntcs.h5",
		res_profile = "resources/res_profile.h5",
		technology_data = "technology-data/outputs/costs_2025.csv",
		dispatchable_plants = "resources/dispatchable_capacities.h5",
		individual_plants = "resources/capacity_tables/individual_plants.h5",
		all_capacities = "resources/all_capacities.h5",
		investcap = "resources/investcap.h5",
		maintenance="resources/maintenance_profiles.h5",
		core_domain = "resources/FBMC/Core_{ty}.h5",
		nordic_domain = "resources/FBMC/Nordic_{ty}.h5",
	params:
		ty = "{ty}",
		cy = "{cy}",
		years = target_years
	output:	
		network= "resources/networks/0/cy{cy}_ty{ty}.nc"
	script:	"scripts/base_model.py"	

rule solve_model:
	input:	network = "resources/networks/{iter}/cy{cy}_ty{ty}.nc",
		reserve_requirements = "data/Dashboard_raw_data/Reserve requirements.csv",
		core_domain = "resources/FBMC/Core_{ty}.h5",
		nordic_domain = "resources/FBMC/Nordic_{ty}.h5",
	params:
		ty = "{ty}",
		cy = "{cy}",
		#years = target_years,
	output:
		solved_network= "results/networks/{iter}/cy{cy}_ty{ty}.nc",
		revenues = "results/revenues/{iter}/cy{cy}_ty{ty}.h5",
		lole = "results/lole/{iter}/cy{cy}_ty{ty}.csv",
	script:	"scripts/solve_model.py"

rule build_initial_capacity_table:
	input:	networks = expand("resources/networks/0/cy{cy}_ty{ty}.nc", cy=climate_years[0], ty=target_years)
	output:	initial_capacity_table = "resources/capacity_tables/0.csv"
	script: "scripts/build_initial_capacity_table.py"

rule build_ordc_parameters:
	input:	pemmdb = "data/Dashboard_raw_data/Reserve requirements.csv",
	output:	ordc_hdf="data/ordc_parameters.h5",
	script:	"scripts/build_ordc_parameters.py"

rule build_maintenance_profiles:
	input:	power_plants="resources/capacity_tables/individual_plants.h5",
		demand = "resources/demand.h5",
		technology_parameters = "resources/technology_parameters.h5",
		all_caps = "resources/all_capacities.h5",
	output:	maintenance_profiles = "resources/maintenance_profiles.h5"
	script:	"scripts/build_maintenance_profiles.py"

rule build_flow_based_data:
	input:	zip_file = "data/fb_domains.zip",
	output:	core_domain = "resources/FBMC/Core_{year}.h5",
		nordic_domain = "resources/FBMC/Nordic_{year}.h5",
	params:	folder="data/fb_domains/",
		years = "{year}",	
	script:	"scripts/build_flow_based_data.py"
	

rule update_capacities:
	input:	old_network = lambda w: ("resources/networks/{iter}/cy{cy}_ty{ty}.nc").format(iter = int(w.iter)-1, cy = w.cy, ty = w.ty),
		capacity_table = "resources/capacity_tables/{iter}.csv"
	params:	ty = "{ty}",
		cy = "{cy}",
	output:	new_network= "resources/networks/{iter}/cy{cy}_ty{ty}.nc"	
	script: "scripts/update_capacities.py"
